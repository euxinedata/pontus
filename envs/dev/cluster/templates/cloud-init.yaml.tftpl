#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - jq

write_files:
  - path: /usr/local/bin/setup-floating-ip
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      ip addr add "${floating_ip}/32" dev eth0 label eth0:1 2>/dev/null || true
      echo "Floating IP ${floating_ip} configured on eth0:1"

  - path: /root/.bashrc
    append: true
    content: |
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

  - path: /etc/systemd/system/floating-ip.service
    content: |
      [Unit]
      Description=Configure Hetzner Floating IP
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/setup-floating-ip
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Enable and start floating IP service
  - systemctl daemon-reload
  - systemctl enable --now floating-ip.service

  # Mount Hetzner volume
  - mkdir -p /mnt/data
  - |
    DEVICE=$(ls /dev/disk/by-id/scsi-0HC_Volume_* 2>/dev/null | head -1)
    if [ -n "$DEVICE" ]; then
      if ! blkid "$DEVICE" > /dev/null 2>&1; then
        mkfs.ext4 -L data "$DEVICE"
      fi
      echo "$DEVICE /mnt/data ext4 defaults,nofail 0 2" >> /etc/fstab
      mount /mnt/data
    fi

  # Write k3s auto-deploy manifests (must be after volume mount)
  - mkdir -p /mnt/data/k3s/server/manifests
  - |
    cat > /mnt/data/k3s/server/manifests/traefik-config.yaml <<'MANIFEST'
    apiVersion: helm.cattle.io/v1
    kind: HelmChartConfig
    metadata:
      name: traefik
      namespace: kube-system
    spec:
      valuesContent: |-
        ports:
          web:
            redirections:
              entryPoint:
                to: websecure
                scheme: https
                permanent: true
    MANIFEST
  - |
    cat > /mnt/data/k3s/server/manifests/argocd-ingress.yaml <<MANIFEST
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: argocd-server
      namespace: argocd
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
    spec:
      ingressClassName: traefik
      tls:
        - hosts:
            - ${argocd_domain}
          secretName: argocd-server-tls
      rules:
        - host: ${argocd_domain}
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: argocd-server
                    port:
                      number: 80
    MANIFEST
  - |
    cat > /mnt/data/k3s/server/manifests/cluster-issuer.yaml <<MANIFEST
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-prod
    spec:
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        email: ${letsencrypt_email}
        privateKeySecretRef:
          name: letsencrypt-prod
        solvers:
          - http01:
              ingress:
                class: traefik
    MANIFEST
  - |
    cat > /mnt/data/k3s/server/manifests/kolkhis-app.yaml <<'MANIFEST'
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: kolkhis
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/euxinedata/pontus.git
        targetRevision: main
        path: apps/kolkhis
      destination:
        server: https://kubernetes.default.svc
        namespace: kolkhis
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        syncOptions:
          - CreateNamespace=true
    MANIFEST

  # Clear stale k3s bootstrap data (token mismatch after cluster rebuild)
  - rm -rf /mnt/data/k3s/server/{db,tls,token,cred}

  # Install k3s
  - curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - --write-kubeconfig-mode=644 --data-dir=/mnt/data/k3s --token="${k3s_token}"

  # Wait for k3s to be ready
  - until /usr/local/bin/kubectl get nodes 2>/dev/null; do sleep 5; done

  # Install k9s
  - curl -sL https://github.com/derailed/k9s/releases/latest/download/k9s_Linux_amd64.tar.gz | tar xz -C /usr/local/bin k9s

  # Install Helm
  - curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  # Install ArgoCD
  - /usr/local/bin/kubectl create namespace argocd --dry-run=client -o yaml | /usr/local/bin/kubectl apply -f -
  - /usr/local/bin/kubectl apply -n argocd --server-side -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  - /usr/local/bin/kubectl -n argocd patch configmap argocd-cmd-params-cm --type merge -p '{"data":{"server.insecure":"true"}}'
  - /usr/local/bin/kubectl -n argocd rollout restart deployment argocd-server
  - /usr/local/bin/kubectl -n argocd rollout status deployment/argocd-server --timeout=60s

  # Install cert-manager
  - /usr/local/bin/kubectl apply --server-side -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.yaml
  - until /usr/local/bin/kubectl -n cert-manager wait --for=condition=Ready pods --all --timeout=120s 2>/dev/null; do sleep 5; done
